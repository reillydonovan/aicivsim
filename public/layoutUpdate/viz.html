<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AI Civilization Simulator — 3D Network</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;background:#080810;color:#fff;font-family:'Space Grotesk',sans-serif}
#cv{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
canvas{display:block}

#ui{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10}

.top-bar{position:absolute;top:0;left:0;right:0;padding:20px 28px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;pointer-events:none}
.top-bar>*{pointer-events:auto}
.brand{font-size:10px;letter-spacing:0.3em;text-transform:uppercase;color:rgba(255,255,255,0.4)}
.brand strong{color:#4ecdc4;font-weight:600}
.site-title{font-size:14px;font-weight:500;color:rgba(255,255,255,0.75);margin-top:3px}
.back-link{font-size:11px;color:rgba(255,255,255,0.3);text-decoration:none;margin-top:6px;display:inline-block;transition:color 0.2s}
.back-link:hover{color:#4ecdc4}

.top-right{display:flex;flex-direction:column;align-items:flex-end;gap:12px;pointer-events:none}
.top-right>*{pointer-events:auto}

.sc-bar{display:flex;gap:2px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:4px;padding:2px}
.sc-btn{font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:500;letter-spacing:0.04em;padding:8px 16px;border:none;background:transparent;color:rgba(255,255,255,0.35);cursor:pointer;border-radius:3px;transition:all 0.3s;white-space:nowrap}
.sc-btn:hover{color:rgba(255,255,255,0.65)}
.sc-btn.active{color:#fff;background:rgba(255,255,255,0.08)}

.mode-bar{display:flex;gap:2px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:4px;padding:2px}
.mode-btn{font-family:'Space Grotesk',sans-serif;font-size:11px;font-weight:500;letter-spacing:0.04em;padding:8px 14px;border:none;background:transparent;color:rgba(255,255,255,0.35);cursor:pointer;border-radius:3px;transition:all 0.3s;white-space:nowrap}
.mode-btn:hover{color:rgba(255,255,255,0.65)}
.mode-btn.on{color:#4ecdc4;background:rgba(78,205,196,0.08)}
.compare-sel{font-family:'Space Grotesk',sans-serif;font-size:10px;padding:4px 8px;background:rgba(0,0,0,0.6);color:rgba(255,255,255,0.6);border:1px solid rgba(255,255,255,0.1);border-radius:3px;outline:none;margin-left:4px}

.agg{text-align:right}
.agg-score{font-family:'JetBrains Mono',monospace;font-size:48px;font-weight:700;line-height:1;transition:color 0.6s}
.agg-sub{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-top:2px}
.agg-grade{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:500;margin-top:3px;transition:color 0.6s}
.agg-status{font-size:11px;color:rgba(255,255,255,0.35);margin-top:6px;max-width:180px;text-align:right;line-height:1.4}

.year-bar{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:14px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);border-radius:4px;padding:8px 20px;backdrop-filter:blur(8px);pointer-events:auto}
.yr-lbl{font-size:10px;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.35)}
.yr-val{font-family:'JetBrains Mono',monospace;font-size:18px;font-weight:600;min-width:48px;text-align:center}
input[type=range]{-webkit-appearance:none;width:220px;height:2px;background:rgba(255,255,255,0.12);border-radius:1px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:#fff;cursor:pointer;border:2px solid rgba(255,255,255,0.3)}
.play-btn{font-family:'Space Grotesk',sans-serif;font-size:11px;padding:5px 12px;border:1px solid rgba(255,255,255,0.12);background:transparent;color:rgba(255,255,255,0.5);border-radius:3px;cursor:pointer;transition:all 0.2s}
.play-btn:hover{color:#fff;border-color:rgba(255,255,255,0.3)}

.info{position:absolute;bottom:28px;right:28px;width:260px;background:rgba(6,6,14,0.8);border:1px solid rgba(255,255,255,0.08);border-radius:4px;padding:18px;backdrop-filter:blur(12px);transition:opacity 0.3s,transform 0.3s,right 0.3s;pointer-events:auto}
.info.hidden{opacity:0;pointer-events:none!important;transform:translateY(8px)}
.info-name{font-size:13px;font-weight:600;transition:color 0.3s}
.info-row{display:flex;align-items:baseline;gap:6px;margin-top:8px}
.info-score{font-family:'JetBrains Mono',monospace;font-size:34px;font-weight:700;line-height:1;transition:color 0.3s}
.info-100{font-size:13px;color:rgba(255,255,255,0.25)}
.info-grade{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;border:1px solid;padding:2px 7px;border-radius:2px;margin-left:4px}
.info-when{font-size:11px;color:rgba(255,255,255,0.3);margin-top:3px}
.info-bar{height:3px;border-radius:2px;background:rgba(255,255,255,0.05);margin-top:12px}
.info-bar-fill{height:100%;border-radius:2px;transition:width 0.5s ease,background 0.5s}
.info-desc{font-size:11px;color:rgba(255,255,255,0.4);margin-top:12px;line-height:1.55}
.info-nav{font-size:10px;color:rgba(255,255,255,0.25);margin-top:10px;font-style:italic}
.world-panel{position:absolute;left:28px;bottom:80px;width:340px;max-height:calc(100vh - 200px);background:rgba(10,10,25,0.88);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;pointer-events:auto;z-index:12;display:flex;flex-direction:column}
.world-panel-head{padding:14px 16px 10px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;justify-content:space-between;align-items:baseline}
.world-panel-title{font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:rgba(255,255,255,0.4)}
.world-panel-year{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700}
.world-panel-body{padding:12px 16px 16px;overflow-y:auto;flex:1}
.ws-hero{display:flex;align-items:baseline;gap:12px;margin-bottom:12px}
.ws-score{font-family:'JetBrains Mono',monospace;font-size:36px;font-weight:800;line-height:1}
.ws-grade{font-size:18px;font-weight:600;border:1px solid;padding:2px 8px;border-radius:3px}
.ws-era{font-size:10px;letter-spacing:0.1em;text-transform:uppercase;opacity:0.5;border:1px solid rgba(255,255,255,0.15);padding:2px 8px;border-radius:3px;margin-left:4px}
.ws-feel{font-size:12px;line-height:1.7;color:rgba(255,255,255,0.45);font-style:italic;margin-bottom:14px}
.ws-section{border-top:1px solid rgba(255,255,255,0.05);padding:10px 0}
.ws-section-label{font-size:9px;letter-spacing:0.1em;text-transform:uppercase;margin-bottom:6px;font-weight:600}
.ws-section p{font-size:11px;line-height:1.65;color:rgba(255,255,255,0.55);margin:0}
.ws-nums{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-top:8px}
.ws-num{text-align:center}
.ws-num .lbl{font-size:7px;letter-spacing:0.05em;text-transform:uppercase;color:rgba(255,255,255,0.3)}
.ws-num .val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;margin-top:2px}
.ws-num .base{font-size:7px;color:rgba(255,255,255,0.2)}
.world-panel.hidden{opacity:0;pointer-events:none!important;transform:translateY(12px)}
.world-panel{transition:opacity 0.3s,transform 0.3s}
@media(max-width:680px){.world-panel{left:8px;right:8px;width:auto;max-height:50vh;bottom:60px}}
.node-charts{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5;transition:opacity 0.3s}
.node-charts.hidden{opacity:0}
.node-chart-card{position:absolute;pointer-events:auto;background:rgba(10,10,25,0.85);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:6px 8px;font-size:9px;letter-spacing:0.04em;min-width:140px;max-width:180px;transform:translate(-50%,-100%);transition:opacity 0.3s}
.node-chart-card .spark{width:100%;height:22px;display:block;margin-top:2px}
.node-chart-title{color:rgba(255,255,255,0.5);text-transform:uppercase;font-size:8px;margin-bottom:3px;text-align:center;white-space:nowrap}
.node-chart-metric{display:flex;justify-content:space-between;align-items:baseline;margin-top:3px}
.node-chart-metric .val{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:10px}
.info-charts{margin-top:12px;border-top:1px solid rgba(255,255,255,0.06);padding-top:8px}
.info-chart-row{margin-bottom:10px}
.info-chart-label{font-size:9px;letter-spacing:0.06em;text-transform:uppercase;color:rgba(255,255,255,0.3);display:flex;justify-content:space-between;align-items:baseline}
.info-chart-val{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600}
.info-chart-row .spark{width:100%;height:28px;display:block;margin-top:2px}
.info-override{margin-top:12px;border-top:1px solid rgba(255,255,255,0.06);padding-top:10px}
.info-override-label{font-size:9px;letter-spacing:0.08em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:6px}
.info-override-btns{display:flex;gap:3px;flex-wrap:wrap}
.ovr-btn{font-family:'Space Grotesk',sans-serif;font-size:9px;padding:3px 8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:rgba(255,255,255,0.3);border-radius:2px;cursor:pointer;transition:all 0.2s;letter-spacing:0.02em}
.ovr-btn:hover{color:rgba(255,255,255,0.6);border-color:rgba(255,255,255,0.2)}
.ovr-btn.ovr-active{font-weight:600}
.ovr-btn.ovr-global{border-style:dashed}

.override-bar{position:absolute;top:50%;left:28px;transform:translateY(-50%);display:flex;flex-direction:column;gap:6px;pointer-events:auto}
.override-chip{display:flex;align-items:center;gap:6px;font-size:10px;background:rgba(6,6,14,0.7);border:1px solid rgba(255,255,255,0.08);border-radius:3px;padding:4px 10px;backdrop-filter:blur(8px);cursor:pointer;transition:all 0.2s;pointer-events:auto}
.override-chip:hover{border-color:rgba(255,255,255,0.2)}
.override-chip .chip-dot{width:8px;height:8px;border-radius:50%}
.override-chip .chip-name{color:rgba(255,255,255,0.5);letter-spacing:0.04em;text-transform:uppercase;font-size:9px}
.override-chip .chip-sc{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:10px}
.override-chip .chip-reset{font-size:9px;color:rgba(255,255,255,0.25);cursor:pointer;margin-left:4px}
.override-chip .chip-reset:hover{color:#d4622a}

#labels{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:5}
.nlabel{position:absolute;text-align:center;pointer-events:none;transition:opacity 0.2s}
.nlabel-name{font-size:9px;letter-spacing:0.1em;text-transform:uppercase;white-space:nowrap;text-shadow:0 0 10px rgba(0,0,0,1),0 0 20px rgba(0,0,0,0.8)}
.nlabel-score{font-family:'JetBrains Mono',monospace;font-size:15px;font-weight:600;text-shadow:0 0 12px rgba(0,0,0,1),0 0 24px rgba(0,0,0,0.8)}

.conn-tip{position:fixed;pointer-events:none;z-index:12;background:rgba(6,6,14,0.9);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:10px 14px;max-width:280px;backdrop-filter:blur(8px);transition:opacity 0.15s;font-size:11px;line-height:1.5}
.conn-tip.hidden{opacity:0}
.conn-tip-head{font-weight:600;margin-bottom:4px}
.conn-tip-pct{font-family:'JetBrains Mono',monospace;font-weight:600}

.tip-event{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:15;pointer-events:none;text-align:center;transition:opacity 0.5s}
.tip-event.hidden{opacity:0}
.tip-event-title{font-size:14px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:#d4622a;text-shadow:0 0 20px rgba(212,98,42,0.6)}
.tip-event-sub{font-size:11px;color:rgba(255,255,255,0.5);margin-top:6px}

/* Compare panel */
.compare-panel{position:absolute;top:50%;right:28px;transform:translateY(-50%);width:300px;background:rgba(6,6,14,0.88);border:1px solid rgba(255,255,255,0.08);border-radius:4px;padding:18px;backdrop-filter:blur(14px);pointer-events:auto;transition:opacity 0.3s,transform 0.3s}
.compare-panel.hidden{opacity:0;pointer-events:none!important;transform:translateY(-50%) translateX(12px)}
.compare-panel-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.compare-panel-title{font-size:11px;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.4)}
.compare-panel table{width:100%;border-collapse:collapse;font-size:11px}
.compare-panel th{text-align:left;color:rgba(255,255,255,0.35);font-weight:500;padding:4px 0;letter-spacing:0.04em;border-bottom:1px solid rgba(255,255,255,0.06)}
.compare-panel td{padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04)}
.compare-panel td:nth-child(2),.compare-panel td:nth-child(3){text-align:center;font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px}
.compare-panel .sys-name{color:rgba(255,255,255,0.5);font-size:10px}
.compare-panel .agg-row td{border-top:1px solid rgba(255,255,255,0.1);font-weight:700;padding-top:8px}
.compare-panel .grade-tag{font-size:9px;font-weight:500;border:1px solid;padding:1px 5px;border-radius:2px;margin-left:3px}
.compare-panel .delta{font-size:9px;display:inline-block;margin-left:2px}
@media(max-width:600px){.compare-panel{right:10px;left:10px;width:auto;top:auto;bottom:90px;transform:none}.compare-panel.hidden{transform:translateY(12px)}}

.hover-tip{position:fixed;pointer-events:none;z-index:20;background:rgba(6,6,14,0.92);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:6px 10px;backdrop-filter:blur(8px);transition:opacity 0.12s;white-space:nowrap}
.hover-tip.hidden{opacity:0}
.hover-tip-name{font-size:10px;letter-spacing:0.06em;text-transform:uppercase;font-weight:500}
.hover-tip-score{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:600;margin-top:2px}
.hover-tip-sub{font-size:9px;color:rgba(255,255,255,0.3);margin-top:1px}

.hint{position:absolute;bottom:90px;left:28px;font-size:10px;color:rgba(255,255,255,0.15);line-height:1.9;letter-spacing:0.02em;pointer-events:none}

@media(max-width:768px){
  .top-bar{padding:12px 14px;flex-direction:column;gap:10px}
  .top-right{align-items:flex-start;gap:8px}
  .sc-bar{flex-wrap:wrap}
  .sc-btn{font-size:10px;padding:6px 10px}
  .agg-score{font-size:32px}
  .agg-status{display:none}
  .year-bar{bottom:12px;padding:6px 12px;gap:8px}
  input[type=range]{width:120px}
  .yr-val{font-size:14px;min-width:40px}
  .info{display:none}
  .hint{display:none}
  .mode-bar{flex-wrap:wrap}
  .mode-bar .mode-btn{font-size:9px;padding:5px 8px}
}
</style>
</head>
<body>

<div id="cv"></div>
<div id="labels"></div>
<div id="conn-tip" class="conn-tip hidden"></div>
<div id="tip-event" class="tip-event hidden"></div>
<div id="hover-tip" class="hover-tip hidden"></div>
<div id="node-charts" class="node-charts hidden"></div>

<div id="ui">
<div id="compare-panel" class="compare-panel hidden"></div>
  <div class="top-bar">
    <div>
      <p class="brand"><strong>AICIVSIM</strong> &mdash; 2026</p>
      <p class="site-title">Civilization Systems Network</p>
      <a href="visualizer.html" class="back-link">&larr; Back to Visualizer</a>
    </div>
    <div class="top-right">
      <div class="sc-bar" id="sc-bar">
        <button class="sc-btn active" data-id="aggressive">Aggressive</button>
        <button class="sc-btn" data-id="moderate">Moderate</button>
        <button class="sc-btn" data-id="bau">BAU</button>
        <button class="sc-btn" data-id="worst">Worst Case</button>
      </div>
      <div class="mode-bar">
        <button class="mode-btn" id="compare-btn">Compare</button>
        <button class="mode-btn" id="globe-btn" style="display:none">Globe</button>
        <button class="mode-btn" id="charts-btn">Charts</button>
        <button class="mode-btn" id="world-btn">World</button>
        <button class="mode-btn on" id="mute-btn">Sound On</button>
      </div>
      <select class="compare-sel" id="compare-sel" style="display:none"></select>
      <div class="agg" id="agg">
        <div class="agg-score" id="agg-score">44</div>
        <div class="agg-sub">Civilization</div>
        <div class="agg-grade" id="agg-grade"></div>
        <div class="agg-status" id="agg-status"></div>
      </div>
    </div>
  </div>

  <div class="year-bar">
    <span class="yr-lbl">Year</span>
    <input type="range" id="yr-slider" min="2026" max="2050" value="2026" step="1">
    <span class="yr-val" id="yr-val">2026</span>
    <button class="play-btn" id="play-btn">&#9654; Play</button>
  </div>

  <div class="info hidden" id="info">
    <div class="info-name" id="info-name"></div>
    <div class="info-row">
      <span class="info-score" id="info-sc">42</span>
      <span class="info-100">/100</span>
      <span class="info-grade" id="info-gr"></span>
    </div>
    <div class="info-when" id="info-when"></div>
    <div class="info-bar"><div class="info-bar-fill" id="info-fill"></div></div>
    <div class="info-proj" id="info-proj" style="font-family:'JetBrains Mono',monospace;font-size:12px;margin-top:10px"></div>
    <div class="info-desc" id="info-desc"></div>
    <div class="info-charts" id="info-charts"></div>
    <div class="info-override" id="info-override"></div>
    <div class="info-nav" id="info-nav"></div>
  </div>

  <div class="override-bar" id="override-bar"></div>

  <div class="world-panel hidden" id="world-panel">
    <div class="world-panel-head">
      <span class="world-panel-title">State of the World</span>
      <span class="world-panel-year" id="world-year"></span>
    </div>
    <div class="world-panel-body" id="world-body"></div>
  </div>

  <div class="hint">Drag to orbit &middot; Scroll to zoom &middot; Click a node<br>
  1-4 scenarios &middot; Space play &middot; &larr;&rarr; year &middot; Esc deselect</div>
</div>

<script src="js/shared.js?v=20260216b"></script>
<script type="importmap">
{"imports":{"three":"https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js","three/addons/":"https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"}}
</script>
<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {EffectComposer} from 'three/addons/postprocessing/EffectComposer.js';
import {RenderPass} from 'three/addons/postprocessing/RenderPass.js';
import {UnrealBloomPass} from 'three/addons/postprocessing/UnrealBloomPass.js';

/* shared.js globals accessible from ES module */
const sparkSVG=window.sparkSVG;
const comparisonSVG=window.comparisonSVG;
const timelineSVG=window.timelineSVG;

/* ================================================================
   DATA
   ================================================================ */
const SYS=[
  {id:'climate',     label:'Climate',      color:0x4ecdc4, today:42, proj:{aggressive:85,moderate:58,bau:28,worst:12},  href:'climate.html',
   desc:'Planetary systems \u2014 temperature, emissions, biodiversity, ocean health, renewable energy, crop yields, water stress, and tipping point risk.'},
  {id:'simulation',  label:'Simulation',   color:0x5da5da, today:50, proj:{aggressive:90,moderate:70,bau:35,worst:15},  href:'simulation.html',
   desc:'The interactive engine \u2014 5 policy levers, 50-year timeline, era-phased narrative reports from possible futures.'},
  {id:'transition',  label:'Transition',   color:0x95cf95, today:43, proj:{aggressive:88,moderate:68,bau:28,worst:12},  href:'transition.html',
   desc:'Workforce readiness \u2014 reskilling rates, poverty trajectories, income bridge calculator, employment metrics.'},
  {id:'ai',          label:'AI',             color:0xe8a838, today:48, proj:{aggressive:92,moderate:68,bau:32,worst:10},  href:'ai.html',
   desc:'Artificial intelligence \u2014 alignment progress, autonomy risk, compute governance, model transparency, and deployment safety.'},
  {id:'governance',  label:'Governance',   color:0xb0a0d0, today:40, proj:{aggressive:85,moderate:65,bau:30,worst:10},  href:'governance.html',
   desc:'Institutional infrastructure \u2014 civic participation, AI charter adoption, citizen assemblies, safety audit coverage.'},
  {id:'strategy',    label:'Strategy',     color:0xe8636e, today:35, proj:{aggressive:88,moderate:62,bau:22,worst:8},   href:'strategy.html',
   desc:'The action catalog \u2014 20+ strategies across individual, institutional, and systemic implementation levels.'}
];
const AGG={today:44,proj:{aggressive:85,moderate:63,bau:28,worst:11}};
const SC_META={
  aggressive:{name:'Aggressive Action',  color:0x4ecdc4,css:'#4ecdc4',outcome:'Systemic recovery underway. Compounding gains across every domain.'},
  moderate:  {name:'Moderate Reform',     color:0x5da5da,css:'#5da5da',outcome:'Moderate improvement. Meaningful but uneven progress.'},
  bau:       {name:'Business as Usual',   color:0xe8a838,css:'#e8a838',outcome:'Systemic decline. The system drifts through inaction.'},
  worst:     {name:'Worst Case',          color:0xd4622a,css:'#d4622a',outcome:'Civilizational failure. Feedback loops accelerate collapse.'}
};

const XSYS=window.CROSS_SYSTEM||{};
function xw(src,tgt,sc){
  const sys=XSYS[src];if(!sys)return{w:0,e:''};
  const imp=sys.impacts.find(function(i){return i.target===tgt});
  if(!imp)return{w:0,e:''};
  const d=imp[sc]||imp.aggressive;
  return{w:d.weight,e:d.effect};
}

const TIPPING=[
  {node:'climate',  label:'Arctic ice-free summer',        thresholds:{bau:2035,worst:2031}},
  {node:'climate',  label:'Coral reef functional collapse', thresholds:{bau:2034,worst:2030}},
  {node:'climate',  label:'Amazon dieback threshold',       thresholds:{bau:2040,worst:2035}},
  {node:'governance',label:'Governance capacity exceeded',  thresholds:{worst:2038}},
  {node:'transition',label:'Mass displacement threshold',   thresholds:{bau:2042,worst:2036}},
  {node:'governance',label:'Democratic backsliding point',  thresholds:{worst:2033}}
];

let active='aggressive',year=2026,playing=false,selNode=null,hovNode=null;
let comparing=false,compareWith='moderate';
let globeActive=false;
let audioMuted=false,audioCtx=null,masterGain=null,baseOsc=null,chordOscs=[],audioInited=false;
const overrides={};
SYS.forEach(s=>{overrides[s.id]=null});
function eff(sysId){return overrides[sysId]||active}
function effScore(d,yr){return scAt(d.today,d.proj[eff(d.id)],yr||year)}
function mixedAgg(yr){
  const y=yr||year;
  let sum=0;nodes.forEach(n=>{sum+=scAt(n.data.today,n.data.proj[eff(n.data.id)],y)});
  return Math.round(sum/nodes.length);
}
const DEFAULT_CAM=new THREE.Vector3(5,7,11);
let flyTarget=null,flyPos=null,flyProgress=1;
let tipFired={};
let trailSpheres=[];

function lerp(a,b,t){return a+(b-a)*t}
function sat(v){return Math.max(0,Math.min(1,v))}
function scAt(today,p,y){if(y<=2026)return today;return Math.round(lerp(today,p,sat((y-2026)/24)))}
function grade(s){
  if(s>=90)return'A';if(s>=85)return'A\u2212';if(s>=80)return'B+';if(s>=70)return'B';
  if(s>=65)return'B\u2212';if(s>=60)return'C+';if(s>=50)return'C';if(s>=45)return'C\u2212';
  if(s>=40)return'D+';if(s>=35)return'D';if(s>=30)return'D\u2212';return'F';
}

/* ================================================================
   THREE.JS SETUP
   ================================================================ */
const box=document.getElementById('cv');
const W=()=>window.innerWidth,H=()=>window.innerHeight;
const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(W(),H());renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.2;
renderer.autoClear=true;
box.appendChild(renderer.domElement);

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x080810);
scene.fog=new THREE.FogExp2(0x080810,0.028);

const camera=new THREE.PerspectiveCamera(45,W()/H(),0.1,120);
camera.position.copy(DEFAULT_CAM);

const ctrl=new OrbitControls(camera,renderer.domElement);
ctrl.enableDamping=true;ctrl.dampingFactor=0.06;
ctrl.maxDistance=22;ctrl.minDistance=4;ctrl.maxPolarAngle=Math.PI*0.52;
ctrl.autoRotate=true;ctrl.autoRotateSpeed=0.35;

const composer=new EffectComposer(renderer);
composer.addPass(new RenderPass(scene,camera));
const bloom=new UnrealBloomPass(new THREE.Vector2(W(),H()),0.8,0.4,0.85);
composer.addPass(bloom);

scene.add(new THREE.AmbientLight(0x222233,0.6));
const dLight=new THREE.DirectionalLight(0xffffff,0.3);
dLight.position.set(5,10,5);scene.add(dLight);

/* ================================================================
   ENVIRONMENT
   ================================================================ */
const gridG=new THREE.PlaneGeometry(50,50,50,50);gridG.rotateX(-Math.PI/2);
const gridM=new THREE.MeshBasicMaterial({color:0x111122,wireframe:true,transparent:true,opacity:0.06});
const gridMesh=new THREE.Mesh(gridG,gridM);gridMesh.position.y=-2.2;scene.add(gridMesh);

const STAR_N=900,starP=new Float32Array(STAR_N*3);
for(let i=0;i<STAR_N;i++){starP[i*3]=(Math.random()-0.5)*70;starP[i*3+1]=Math.random()*35+5;starP[i*3+2]=(Math.random()-0.5)*70}
const starG=new THREE.BufferGeometry();starG.setAttribute('position',new THREE.BufferAttribute(starP,3));
scene.add(new THREE.Points(starG,new THREE.PointsMaterial({color:0xffffff,size:0.04,transparent:true,opacity:0.35})));

const R=5;
const ringG=new THREE.RingGeometry(R-0.08,R+0.08,72);ringG.rotateX(-Math.PI/2);
const ringM=new THREE.MeshBasicMaterial({color:0x4ecdc4,transparent:true,opacity:0.03,side:THREE.DoubleSide});
const ringMesh=new THREE.Mesh(ringG,ringM);ringMesh.position.y=-0.6;scene.add(ringMesh);

const pulseG=new THREE.RingGeometry(0.05,0.15,64);pulseG.rotateX(-Math.PI/2);
const pulseM=new THREE.MeshBasicMaterial({color:0x4ecdc4,transparent:true,opacity:0.12,side:THREE.DoubleSide});
const pulseMesh=new THREE.Mesh(pulseG,pulseM);pulseMesh.position.y=-0.55;scene.add(pulseMesh);

/* Globe wireframe */
const globeGeo=new THREE.IcosahedronGeometry(R,3);
const globeMat=new THREE.MeshBasicMaterial({color:0x222244,wireframe:true,transparent:true,opacity:0.06});
const globeMesh=new THREE.Mesh(globeGeo,globeMat);globeMesh.visible=false;scene.add(globeMesh);

function ll2v(lat,lon,r){
  const p=(90-lat)*Math.PI/180,t=lon*Math.PI/180;
  return new THREE.Vector3(r*Math.sin(p)*Math.cos(t),r*Math.cos(p),r*Math.sin(p)*Math.sin(t));
}
const GLOBE_POS=[ll2v(60,10,R),ll2v(15,-75,R),ll2v(35,110,R),ll2v(-5,25,R),ll2v(50,-5,R),ll2v(-35,145,R)];
const GLOBE_CENTER=new THREE.Vector3(0,0,0);

/* Glow texture */
const glowTex=(function(){
  const c=document.createElement('canvas');c.width=128;c.height=128;
  const x=c.getContext('2d'),g=x.createRadialGradient(64,64,0,64,64,64);
  g.addColorStop(0,'rgba(255,255,255,0.5)');g.addColorStop(0.25,'rgba(255,255,255,0.12)');g.addColorStop(1,'rgba(255,255,255,0)');
  x.fillStyle=g;x.fillRect(0,0,128,128);return new THREE.CanvasTexture(c);
})();

/* ================================================================
   NODES
   ================================================================ */
const nodes=[];
const cGeo=new THREE.IcosahedronGeometry(0.6,2);
const cMat=new THREE.MeshPhongMaterial({color:0xffffff,emissive:0x333333,transparent:true,opacity:0.7});
const cMesh=new THREE.Mesh(cGeo,cMat);
const cWG=new THREE.IcosahedronGeometry(0.78,1);
const cWM=new THREE.MeshBasicMaterial({color:0xffffff,wireframe:true,transparent:true,opacity:0.12});
const cWire=new THREE.Mesh(cWG,cWM);cMesh.add(cWire);
cMesh.position.set(0,0.3,0);scene.add(cMesh);
const centerNode={mesh:cMesh,wire:cWire,data:null,isCenter:true,bp:new THREE.Vector3(0,0.3,0),netPos:new THREE.Vector3(0,0.3,0),globePos:GLOBE_CENTER.clone()};

const alarmRingGeo=new THREE.RingGeometry(0.5,0.55,32);alarmRingGeo.rotateX(-Math.PI/2);
SYS.forEach((s,i)=>{
  const a=(i/6)*Math.PI*2-Math.PI/2;
  const x=Math.cos(a)*R,z=Math.sin(a)*R;
  const mat=new THREE.MeshPhongMaterial({color:s.color,emissive:s.color,emissiveIntensity:0.3,transparent:true,opacity:0.85});
  const mesh=new THREE.Mesh(new THREE.IcosahedronGeometry(0.42,2),mat);
  const wm=new THREE.MeshBasicMaterial({color:s.color,wireframe:true,transparent:true,opacity:0.18});
  const wire=new THREE.Mesh(new THREE.IcosahedronGeometry(0.58,1),wm);mesh.add(wire);
  const sm=new THREE.SpriteMaterial({color:s.color,transparent:true,opacity:0.12,map:glowTex});
  const spr=new THREE.Sprite(sm);spr.scale.set(3,3,1);mesh.add(spr);
  const aRingMat=new THREE.MeshBasicMaterial({color:s.color,transparent:true,opacity:0,side:THREE.DoubleSide});
  const aRing=new THREE.Mesh(alarmRingGeo.clone(),aRingMat);mesh.add(aRing);
  const bp=new THREE.Vector3(x,0,z);
  mesh.position.copy(bp);scene.add(mesh);
  nodes.push({mesh,wire,spriteMat:sm,alarmRing:aRing,alarmMat:aRingMat,data:s,isCenter:false,bp:bp.clone(),netPos:bp.clone(),globePos:GLOBE_POS[i].clone(),angle:a,color:new THREE.Color(s.color),baseColor:new THREE.Color(s.color),idx:i,health:1,alarmPhase:Math.random()*Math.PI*2});
});

/* ================================================================
   CONNECTIONS
   ================================================================ */
const conns=[];
for(let i=0;i<nodes.length;i++)for(let j=i+1;j<nodes.length;j++) mkConn(nodes[i],nodes[j],false);
nodes.forEach(n=>mkConn(n,centerNode,true));

function buildCurve(a,b,toC){
  const mid=new THREE.Vector3().addVectors(a.bp,b.bp).multiplyScalar(0.5);
  if(globeActive){mid.normalize().multiplyScalar(R*1.15)}
  else{mid.y+=toC?1.2:1.8}
  return new THREE.QuadraticBezierCurve3(a.bp.clone(),mid,b.bp.clone());
}
function mkConn(a,b,toC){
  const curve=buildCurve(a,b,toC);
  const geo=new THREE.BufferGeometry().setFromPoints(curve.getPoints(48));
  const mat=new THREE.LineBasicMaterial({color:0x444466,transparent:true,opacity:0.04});
  const line=new THREE.Line(geo,mat);scene.add(line);
  conns.push({line,mat,a,b,curve,toC});
}
function rebuildConns(){
  conns.forEach(c=>{
    c.curve=buildCurve(c.a,c.b,c.toC);
    const pts=c.curve.getPoints(48);
    c.line.geometry.dispose();
    c.line.geometry=new THREE.BufferGeometry().setFromPoints(pts);
  });
}

/* ================================================================
   PARTICLES
   ================================================================ */
const PPC=10,totalP=conns.length*PPC;
const pGeo=new THREE.BufferGeometry();
const pPos=new Float32Array(totalP*3);
const pCol=new Float32Array(totalP*3);
const pData=[];
let pi=0;
conns.forEach((c,ci)=>{
  const cA=new THREE.Color(c.a.isCenter?0xffffff:c.a.data.color);
  const cB=new THREE.Color(c.b.isCenter?0xffffff:c.b.data.color);
  for(let p=0;p<PPC;p++){
    const t=Math.random(),spd=0.0008+Math.random()*0.0025;
    pData.push({ci,t,spd,scatter:0});
    const col=cA.clone().lerp(cB,t);
    pCol[pi*3]=col.r;pCol[pi*3+1]=col.g;pCol[pi*3+2]=col.b;
    pi++;
  }
});
pGeo.setAttribute('position',new THREE.BufferAttribute(pPos,3));
pGeo.setAttribute('color',new THREE.BufferAttribute(pCol,3));
const pMat=new THREE.PointsMaterial({size:0.06,vertexColors:true,transparent:true,opacity:0.6,blending:THREE.AdditiveBlending,depthWrite:false});
const pMesh=new THREE.Points(pGeo,pMat);scene.add(pMesh);

/* ================================================================
   LABELS
   ================================================================ */
const labelBox=document.getElementById('labels');
const labels=[];
function mkLabel(node,isCenter){
  const el=document.createElement('div');el.className='nlabel';
  const col=isCenter?'#ffffff':'#'+node.color.getHexString();
  const colFade=isCenter?'rgba(255,255,255,0.45)':col+'88';
  el.innerHTML='<div class="nlabel-score" style="color:'+col+'"></div><div class="nlabel-name" style="color:'+colFade+'">'+(isCenter?'CIVILIZATION':node.data.label)+'</div>';
  labelBox.appendChild(el);
  return{el,node:isCenter?centerNode:node,mesh:isCenter?cMesh:node.mesh,isCenter,scoreEl:el.querySelector('.nlabel-score')};
}
labels.push(mkLabel(null,true));
nodes.forEach(n=>labels.push(mkLabel(n,false)));

/* ================================================================
   HIT TARGETS
   ================================================================ */
const hitMat=new THREE.MeshBasicMaterial({visible:false});
const hitTargets=[];
function addHit(mesh,node){const h=new THREE.Mesh(new THREE.SphereGeometry(1.2,8,8),hitMat);mesh.add(h);hitTargets.push({mesh:h,node})}
addHit(cMesh,centerNode);nodes.forEach(n=>addHit(n.mesh,n));
const allHitMeshes=hitTargets.map(h=>h.mesh);

/* ================================================================
   TIPPING POINT SHOCKWAVES
   ================================================================ */
const shockPool=[];
for(let i=0;i<3;i++){
  const g=new THREE.RingGeometry(0.1,0.2,32);g.rotateX(-Math.PI/2);
  const m=new THREE.MeshBasicMaterial({color:0xd4622a,transparent:true,opacity:0,side:THREE.DoubleSide});
  const mesh=new THREE.Mesh(g,m);mesh.visible=false;scene.add(mesh);
  shockPool.push({mesh,mat:m,active:false,t:0,origin:new THREE.Vector3()});
}
function spawnShock(pos){
  const s=shockPool.find(x=>!x.active);if(!s)return;
  s.active=true;s.t=0;s.origin.copy(pos);s.mesh.position.copy(pos);s.mesh.scale.set(0.1,0.1,0.1);s.mat.opacity=0.5;s.mesh.visible=true;
}

/* ================================================================
   TIMELINE TRAIL
   ================================================================ */
const trailMat=new THREE.MeshBasicMaterial({transparent:true,depthWrite:false});
const trailGeo=new THREE.SphereGeometry(0.08,6,6);
function clearTrail(){trailSpheres.forEach(s=>{scene.remove(s.mesh);s.mesh.geometry.dispose()});trailSpheres=[]}

/* ================================================================
   SOUND — Cosmic symphony: consonant when aligned, dissonant when fractured
   Each system is a voice in a chord. Healthy = harmonic unity.
   Sick = drift, microtonal beating, rhythmic desync.
   Kept deliberately quiet and ambient throughout.
   ================================================================ */
let voices=[];
let alarmOsc=null,alarmGain=null;
let noiseNode=null,noiseGain=null;

/* Harmonic voices — a warm Cmaj9 spread when fully aligned */
const VOICE_FREQ=[
  130.81,  /* Climate    — C3  (root) */
  164.81,  /* Simulation — E3  (major 3rd) */
  196.00,  /* Transition — G3  (5th) */
  246.94,  /* AI          — B3 (major 7th) */
  293.66,  /* Governance — D4  (9th) */
  220.00   /* Strategy   — A3  (6th) */
];
/* Where each voice drifts when that system is sick — dissonant intervals */
const VOICE_SICK=[
  138.59,  /* C#3 — semitone rub */
  155.56,  /* Eb3 — minor 3rd clash */
  207.65,  /* Ab3 — tritone area */
  233.08,  /* Bb3 — minor 7th */
  311.13,  /* Eb4 — minor tension */
  207.65   /* Ab3 — tritone */
];

function initAudio(){
  if(audioInited)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  masterGain=audioCtx.createGain();masterGain.gain.value=0;masterGain.connect(audioCtx.destination);

  /* Base drone — sub-bass anchor */
  baseOsc=audioCtx.createOscillator();baseOsc.type='sine';baseOsc.frequency.value=55;
  const bg=audioCtx.createGain();bg.gain.value=0.06;baseOsc.connect(bg);bg.connect(masterGain);baseOsc.start();

  /* Harmonic shimmer pad — 3 quiet upper partials */
  [440,554,660].forEach(f=>{
    const o=audioCtx.createOscillator();o.type='sine';o.frequency.value=f;
    const g=audioCtx.createGain();g.gain.value=0.006;o.connect(g);g.connect(masterGain);o.start();
    chordOscs.push({osc:o,gain:g});
  });

  /* Per-system voices — the core of the symphony */
  nodes.forEach((n,i)=>{
    const primary=audioCtx.createOscillator();
    primary.type='sine';primary.frequency.value=VOICE_FREQ[i];
    /* Quiet fifth above for shimmer (only when healthy) */
    const shimmer=audioCtx.createOscillator();
    shimmer.type='sine';shimmer.frequency.value=VOICE_FREQ[i]*1.5;
    const pGain=audioCtx.createGain();pGain.gain.value=0;
    const sGain=audioCtx.createGain();sGain.gain.value=0;
    /* Gentle lowpass to keep voices warm, not harsh */
    const filter=audioCtx.createBiquadFilter();
    filter.type='lowpass';filter.frequency.value=1200;filter.Q.value=0.7;
    primary.connect(filter);shimmer.connect(sGain);
    filter.connect(pGain);pGain.connect(masterGain);sGain.connect(masterGain);
    primary.start();shimmer.start();
    voices.push({primary,shimmer,pGain,sGain,filter,
      baseFreq:VOICE_FREQ[i],sickFreq:VOICE_SICK[i],shimmerBase:VOICE_FREQ[i]*1.5,
      phase:i*(Math.PI*2/6)});
  });

  /* Alarm pulse — sub-bass throb for critical aggregate */
  alarmOsc=audioCtx.createOscillator();alarmOsc.type='sawtooth';alarmOsc.frequency.value=45;
  alarmGain=audioCtx.createGain();alarmGain.gain.value=0;
  const af=audioCtx.createBiquadFilter();af.type='lowpass';af.frequency.value=100;
  alarmOsc.connect(af);af.connect(alarmGain);alarmGain.connect(masterGain);alarmOsc.start();

  /* Noise bed — filtered breath for tension */
  const bufSize=audioCtx.sampleRate*2;
  const buf=audioCtx.createBuffer(1,bufSize,audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let j=0;j<bufSize;j++)d[j]=(Math.random()*2-1)*0.3;
  noiseNode=audioCtx.createBufferSource();noiseNode.buffer=buf;noiseNode.loop=true;
  const nf=audioCtx.createBiquadFilter();nf.type='bandpass';nf.frequency.value=350;nf.Q.value=1.5;
  noiseGain=audioCtx.createGain();noiseGain.gain.value=0;
  noiseNode.connect(nf);nf.connect(noiseGain);noiseGain.connect(masterGain);noiseNode.start();
  audioInited=true;
}

function updateAudio(){
  if(!audioInited||audioMuted)return;
  const now=audioCtx.currentTime;
  const h=aggHealth;
  const ramp=0.6;

  /* Base drone — pitch sinks slightly when world is sick */
  baseOsc.frequency.setTargetAtTime(50+h*10,now,ramp);

  /* Upper shimmer pad — brighter when healthy, muted when sick */
  const padTargets=[440,554,660];
  const padSick=[466,523,622];
  chordOscs.forEach((o,i)=>{
    o.osc.frequency.setTargetAtTime(lerp(padSick[i],padTargets[i],h),now,ramp);
    o.gain.gain.setTargetAtTime(h*0.008,now,ramp);
  });

  /* The symphony: per-system voices */
  const baseRate=0.15;
  nodes.forEach((n,idx)=>{
    const v=voices[idx];if(!v)return;
    const nh=n.health;

    /* Pitch: healthy = consonant chord tone, sick = drifts toward dissonant interval */
    const freq=lerp(v.sickFreq,v.baseFreq,nh);
    /* Subtle vibrato that widens as health drops — like an instrument losing control */
    const vibratoDepth=(1-nh)*6;
    const vibratoRate=lerp(0.5,4,1-nh);
    const vibrato=vibratoDepth*Math.sin(now*vibratoRate*Math.PI*2+v.phase);
    v.primary.frequency.setTargetAtTime(freq+vibrato,now,0.12);

    /* Shimmer fifth: present when healthy, fades when sick */
    v.shimmer.frequency.setTargetAtTime(freq*1.5+vibrato*0.5,now,0.12);
    v.sGain.gain.setTargetAtTime(nh*nh*0.005,now,ramp);

    /* Volume with rhythmic pulse — synchronized when healthy, drifting when sick */
    const syncRate=baseRate;
    const drift=(1-nh)*0.08;
    const nodeRate=syncRate+drift;
    const syncPhase=now*syncRate*Math.PI*2;
    const nodePhase=now*nodeRate*Math.PI*2+v.phase*(1-nh);
    const pulse=0.5+0.5*Math.sin(lerp(nodePhase,syncPhase,nh));

    const baseVol=0.012;
    const healthVol=baseVol+nh*0.008;
    v.pGain.gain.setTargetAtTime(healthVol*pulse,now,0.08);

    /* Filter opens when healthy, closes when sick — muffled distress */
    v.filter.frequency.setTargetAtTime(400+nh*1600,now,ramp);
  });

  /* Alarm: gentle sub-bass pulse below 35% aggregate */
  const alarmAmt=Math.max(0,(0.35-h)/0.35);
  const alarmPulse=alarmAmt*0.03*Math.abs(Math.sin(now*(1.5+alarmAmt*2)));
  alarmGain.gain.setTargetAtTime(alarmPulse,now,0.08);
  alarmOsc.frequency.setTargetAtTime(38+alarmAmt*20,now,0.3);

  /* Noise bed: faint hiss when things deteriorate */
  const noiseAmt=Math.max(0,(0.45-h)/0.45)*0.012;
  noiseGain.gain.setTargetAtTime(noiseAmt,now,0.4);
}
function pingNode(idx){
  if(!audioInited||audioMuted)return;
  const f=VOICE_FREQ[idx]||220;
  const now=audioCtx.currentTime;
  const o=audioCtx.createOscillator();o.type='sine';o.frequency.value=f*2;
  const g=audioCtx.createGain();g.gain.value=0.06;g.gain.exponentialRampToValueAtTime(0.001,now+0.5);
  o.connect(g);g.connect(masterGain);o.start();o.stop(now+0.5);
}
function sfx(type){
  if(!audioInited||audioMuted)return;
  const now=audioCtx.currentTime;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.connect(g);g.connect(masterGain);
  switch(type){
    case 'hover':
      o.type='sine';o.frequency.value=880;o.frequency.exponentialRampToValueAtTime(1100,now+0.06);
      g.gain.value=0.04;g.gain.exponentialRampToValueAtTime(0.001,now+0.08);
      o.start(now);o.stop(now+0.08);break;
    case 'unhover':
      o.type='sine';o.frequency.value=660;o.frequency.exponentialRampToValueAtTime(440,now+0.06);
      g.gain.value=0.025;g.gain.exponentialRampToValueAtTime(0.001,now+0.07);
      o.start(now);o.stop(now+0.07);break;
    case 'select':
      o.type='sine';o.frequency.value=440;
      g.gain.value=0.08;g.gain.exponentialRampToValueAtTime(0.001,now+0.25);
      o.start(now);o.stop(now+0.25);
      const o2=audioCtx.createOscillator();const g2=audioCtx.createGain();
      o2.type='sine';o2.frequency.value=660;o2.connect(g2);g2.connect(masterGain);
      g2.gain.value=0.06;g2.gain.exponentialRampToValueAtTime(0.001,now+0.3);
      o2.start(now+0.05);o2.stop(now+0.3);break;
    case 'deselect':
      o.type='sine';o.frequency.value=550;o.frequency.exponentialRampToValueAtTime(330,now+0.15);
      g.gain.value=0.05;g.gain.exponentialRampToValueAtTime(0.001,now+0.18);
      o.start(now);o.stop(now+0.18);break;
    case 'scenario':
      o.type='triangle';o.frequency.value=300;o.frequency.exponentialRampToValueAtTime(600,now+0.12);
      g.gain.value=0.06;g.gain.linearRampToValueAtTime(0.03,now+0.06);g.gain.exponentialRampToValueAtTime(0.001,now+0.2);
      o.start(now);o.stop(now+0.2);break;
    case 'override':
      o.type='square';o.frequency.value=520;o.frequency.exponentialRampToValueAtTime(780,now+0.08);
      const bf=audioCtx.createBiquadFilter();bf.type='lowpass';bf.frequency.value=2000;
      o.disconnect();o.connect(bf);bf.connect(g);g.connect(masterGain);
      g.gain.value=0.035;g.gain.exponentialRampToValueAtTime(0.001,now+0.15);
      o.start(now);o.stop(now+0.15);break;
    default:
      o.type='sine';o.frequency.value=440;
      g.gain.value=0.04;g.gain.exponentialRampToValueAtTime(0.001,now+0.1);
      o.start(now);o.stop(now+0.1);
  }
}

/* ================================================================
   CAMERA FLY-TO
   ================================================================ */
function flyTo(target){
  if(!target||target.isCenter){flyToOverview();return}
  const dir=new THREE.Vector3().subVectors(camera.position,target.mesh.position).normalize();
  flyPos=target.mesh.position.clone().add(dir.multiplyScalar(3.5)).add(new THREE.Vector3(0,1.5,0));
  flyTarget=target.mesh.position.clone();
  flyProgress=0;ctrl.autoRotate=false;
}
function flyToOverview(){
  flyPos=DEFAULT_CAM.clone();flyTarget=new THREE.Vector3(0,0,0);flyProgress=0;
  setTimeout(()=>{ctrl.autoRotate=true},1200);
}

/* ================================================================
   RAYCASTER + INTERACTION
   Drag vs click: only fire selection logic if pointer barely moved.
   ================================================================ */
const ray=new THREE.Raycaster();
const mouse=new THREE.Vector2();
let mouseScreen={x:0,y:0};
let pointerDownPos={x:0,y:0};
const CLICK_THRESHOLD=6;
function setMouse(e){mouse.x=(e.clientX/W())*2-1;mouse.y=-(e.clientY/H())*2+1;mouseScreen={x:e.clientX,y:e.clientY}}
document.addEventListener('mousemove',setMouse);

renderer.domElement.addEventListener('pointerdown',e=>{pointerDownPos={x:e.clientX,y:e.clientY}});
let lastDeselectTime=0;
renderer.domElement.addEventListener('click',e=>{
  const dx=e.clientX-pointerDownPos.x,dy=e.clientY-pointerDownPos.y;
  if(dx*dx+dy*dy>CLICK_THRESHOLD*CLICK_THRESHOLD)return;
  if(hovNode){
    const wasSelected=selNode===hovNode;
    selNode=wasSelected?null:hovNode;
    if(selNode){sfx('select');flyTo(selNode);if(!selNode.isCenter)pingNode(selNode.idx||0)}
    else{sfx('deselect');lastDeselectTime=performance.now();flyToOverview()}
    updateInfo();renderOverrideBar();
  }else if(selNode){
    sfx('deselect');selNode=null;lastDeselectTime=performance.now();updateInfo();renderOverrideBar();
  }
});
renderer.domElement.addEventListener('dblclick',()=>{
  if(performance.now()-lastDeselectTime<400)return;
  if(hovNode&&!hovNode.isCenter&&hovNode.data.href) window.location.href=hovNode.data.href;
});

let touchStartPos={x:0,y:0};
renderer.domElement.addEventListener('touchstart',e=>{
  if(e.touches.length)touchStartPos={x:e.touches[0].clientX,y:e.touches[0].clientY};
},{passive:true});
renderer.domElement.addEventListener('touchend',e=>{
  if(e.changedTouches.length){
    const t0=e.changedTouches[0];
    const dx=t0.clientX-touchStartPos.x,dy=t0.clientY-touchStartPos.y;
    if(dx*dx+dy*dy>CLICK_THRESHOLD*CLICK_THRESHOLD)return;
    setMouse(t0);
    ray.setFromCamera(mouse,camera);
    const hits=ray.intersectObjects(allHitMeshes);
    if(hits.length){
      const t=hitTargets.find(h=>h.mesh===hits[0].object);
      if(t){
        selNode=selNode===t.node?null:t.node;
        if(selNode){sfx('select');flyTo(selNode)}
        else{sfx('deselect');flyToOverview()}
        updateInfo();renderOverrideBar();
      }
    }else if(selNode){
      sfx('deselect');selNode=null;updateInfo();renderOverrideBar();
    }
  }
},{passive:true});

/* ================================================================
   KEYBOARD SHORTCUTS
   ================================================================ */
const scKeys=['aggressive','moderate','bau','worst'];
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT')return;
  if(e.key>='1'&&e.key<='4'){switchScenario(scKeys[+e.key-1]);e.preventDefault()}
  if(e.key===' '){togglePlay();e.preventDefault()}
  if(e.key==='ArrowLeft'){stepYear(-1);e.preventDefault()}
  if(e.key==='ArrowRight'){stepYear(1);e.preventDefault()}
  if(e.key==='Escape'){sfx('deselect');selNode=null;flyToOverview();updateInfo();renderOverrideBar();e.preventDefault()}
});
function stepYear(d){year=Math.max(2026,Math.min(2050,year+d));yrSlider.value=year;yrVal.textContent=year;updateVis()}
function togglePlay(){playing=!playing;playBtn.innerHTML=playing?'&#9646;&#9646; Pause':'&#9654; Play'}

/* ================================================================
   UI WIRING
   ================================================================ */
function rebuildCompareSel(){
  const opts=['aggressive','moderate','bau','worst'];
  const names={aggressive:'Aggressive',moderate:'Moderate',bau:'BAU',worst:'Worst Case'};
  compareSel.innerHTML='';
  opts.filter(o=>o!==active).forEach(o=>{
    const el=document.createElement('option');el.value=o;el.textContent=names[o];
    if(o===compareWith)el.selected=true;
    compareSel.appendChild(el);
  });
  if(compareWith===active){compareWith=opts.filter(o=>o!==active)[0];compareSel.value=compareWith}
}
function switchScenario(id){
  active=id;
  document.querySelectorAll('.sc-btn').forEach(x=>x.classList.remove('active'));
  const btn=document.querySelector('.sc-btn[data-id="'+id+'"]');if(btn)btn.classList.add('active');
  rebuildCompareSel();
  sfx('scenario');clearTrail();tipFired={};updateVis();renderOverrideBar();
}
document.querySelectorAll('.sc-btn').forEach(b=>b.addEventListener('click',()=>switchScenario(b.dataset.id)));
const yrSlider=document.getElementById('yr-slider'),yrVal=document.getElementById('yr-val');
yrSlider.addEventListener('input',()=>{year=+yrSlider.value;yrVal.textContent=year;updateVis()});
const playBtn=document.getElementById('play-btn');
playBtn.addEventListener('click',togglePlay);

/* Compare */
const compareBtn=document.getElementById('compare-btn');
const compareSel=document.getElementById('compare-sel');
const comparePanel=document.getElementById('compare-panel');
const infoPanel=document.getElementById('info');
compareBtn.addEventListener('click',()=>{
  comparing=!comparing;
  compareBtn.classList.toggle('on',comparing);
  compareSel.style.display=comparing?'inline-block':'none';
  comparePanel.classList.toggle('hidden',!comparing);
  infoPanel.style.right=comparing?'340px':'28px';
  updateComparePanel();
});
compareSel.addEventListener('change',()=>{compareWith=compareSel.value;updateComparePanel()});
rebuildCompareSel();
function updateComparePanel(){
  if(!comparing){comparePanel.classList.add('hidden');return}
  const scA=SC_META[active],scB=SC_META[compareWith];
  let h='<div class="compare-panel-head"><span class="compare-panel-title">Scenario Comparison &mdash; '+year+'</span></div>';
  h+='<table><tr><th></th><th style="color:'+scA.css+'">Current</th><th style="color:'+scB.css+'">'+scB.name+'</th></tr>';
  let sumCur=0,sumAlt=0;
  nodes.forEach(n=>{
    const d=n.data;
    const curSc=eff(d.id);
    const sA=scAt(d.today,d.proj[curSc],year),sB=scAt(d.today,d.proj[compareWith],year);
    sumCur+=sA;sumAlt+=sB;
    const gA=grade(sA),gB=grade(sB);
    const diff=sB-sA;
    const diffStr=diff>0?'<span style="color:#4ecdc4;font-size:9px">+'+diff+'</span>':diff<0?'<span style="color:#d4622a;font-size:9px">'+diff+'</span>':'<span style="color:rgba(255,255,255,0.25);font-size:9px">0</span>';
    const curMeta=SC_META[curSc];
    const ovrDot=overrides[d.id]?'<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:'+curMeta.css+';margin-right:3px"></span>':'';
    h+='<tr><td class="sys-name" style="color:#'+n.color.getHexString()+'">'+ovrDot+d.label+'</td>';
    h+='<td style="color:'+curMeta.css+'">'+sA+' <span class="grade-tag" style="color:'+curMeta.css+';border-color:'+curMeta.css+'">'+gA+'</span></td>';
    h+='<td style="color:'+scB.css+'">'+sB+' <span class="grade-tag" style="color:'+scB.css+';border-color:'+scB.css+'">'+gB+'</span> '+diffStr+'</td>';
    h+='</tr>';
  });
  const aggCur=Math.round(sumCur/nodes.length),aggAlt=Math.round(sumAlt/nodes.length);
  const aggDiff=aggAlt-aggCur;
  const aggDiffStr=aggDiff>0?'<span style="color:#4ecdc4;font-size:9px">+'+aggDiff+'</span>':aggDiff<0?'<span style="color:#d4622a;font-size:9px">'+aggDiff+'</span>':'<span style="color:rgba(255,255,255,0.25);font-size:9px">0</span>';
  h+='<tr class="agg-row"><td class="sys-name">Aggregate</td>';
  h+='<td>'+aggCur+' <span class="grade-tag">'+grade(aggCur)+'</span></td>';
  h+='<td style="color:'+scB.css+'">'+aggAlt+' <span class="grade-tag" style="color:'+scB.css+';border-color:'+scB.css+'">'+grade(aggAlt)+'</span> '+aggDiffStr+'</td>';
  h+='</tr></table>';
  comparePanel.innerHTML=h;
}

/* Globe */
const globeBtn=document.getElementById('globe-btn');
globeBtn.addEventListener('click',()=>{
  globeActive=!globeActive;
  globeBtn.classList.toggle('on',globeActive);
  globeMesh.visible=globeActive;
  gridMesh.visible=!globeActive;
  ringMesh.visible=!globeActive;
  pulseMesh.visible=!globeActive;
  nodes.forEach((n,i)=>{
    n.bp.copy(globeActive?n.globePos:n.netPos);
    n.mesh.position.copy(n.bp);
  });
  centerNode.bp.copy(globeActive?centerNode.globePos:centerNode.netPos);
  cMesh.position.copy(centerNode.bp);
  rebuildConns();
  updateVis();
});

/* Floating charts on nodes */
let chartsActive=false;
const chartsBtn=document.getElementById('charts-btn');
const nodeChartsEl=document.getElementById('node-charts');
chartsBtn.addEventListener('click',()=>{
  chartsActive=!chartsActive;
  chartsBtn.classList.toggle('on',chartsActive);
  nodeChartsEl.classList.toggle('hidden',!chartsActive);
  sfx(chartsActive?'select':'deselect');
  if(chartsActive)renderNodeCharts();
});

function renderNodeCharts(){
  const VM=window.VIZ_METRICS;if(!VM){nodeChartsEl.innerHTML='';return}
  let html='';
  nodes.forEach(n=>{
    const sysId=n.data.id;
    const metrics=VM[sysId];if(!metrics||!metrics.length)return;
    const m=metrics[0];
    const nSc=eff(sysId);
    const yi=Math.min(24,Math.max(0,year-2026));
    const d=m.data[nSc];
    const curVal=d[yi];
    const clr='#'+new THREE.Color(n.data.color).getHexString();
    const scClr=SC_META[nSc].css;
    html+='<div class="node-chart-card" data-sys="'+sysId+'">';
    html+='<div class="node-chart-title" style="color:'+clr+'">'+n.data.label+'</div>';
    html+=timelineSVG(m.data,{aggressive:'#4ecdc4',moderate:'#5da5da',bau:'#e8a838',worst:'#d4622a'},nSc,160,24,['\'26','\'50'],yi);
    html+='<div class="node-chart-metric"><span style="color:rgba(255,255,255,0.4)">'+m.label+'</span><span class="val" style="color:'+scClr+'">'+curVal.toFixed(m.unit==='%'||m.unit==='/100'?0:1)+m.unit+'</span></div>';
    html+='</div>';
  });
  nodeChartsEl.innerHTML=html;
}

function positionNodeCharts(){
  if(!chartsActive)return;
  const cards=nodeChartsEl.querySelectorAll('.node-chart-card');
  cards.forEach(card=>{
    const sysId=card.dataset.sys;
    const n=nodes.find(x=>x.data.id===sysId);if(!n)return;
    const v=n.mesh.position.clone();
    v.project(camera);
    const hw=window.innerWidth/2,hh=window.innerHeight/2;
    const sx=(v.x*hw)+hw;
    const sy=-(v.y*hh)+hh;
    const behind=v.z>1;
    card.style.left=sx+'px';
    card.style.top=(sy-30)+'px';
    card.style.opacity=behind?'0':'1';
  });
}

/* World State panel */
let worldActive=false;
const worldBtn=document.getElementById('world-btn');
const worldPanel=document.getElementById('world-panel');
const worldYear=document.getElementById('world-year');
const worldBody=document.getElementById('world-body');

worldBtn.addEventListener('click',()=>{
  worldActive=!worldActive;
  worldBtn.classList.toggle('on',worldActive);
  worldPanel.classList.toggle('hidden',!worldActive);
  sfx(worldActive?'select':'deselect');
  if(worldActive)updateWorldPanel();
});

function updateWorldPanel(){
  if(!worldActive||!window.simWorldState)return;
  const sc=active;
  const yr=Math.max(2027,year);
  const w=window.simWorldState(sc,yr);
  worldYear.textContent=yr;
  worldYear.style.color=w.scenarioCss;

  const sColors={livelihoods:'#95cf95',climate:'#4ecdc4',governance:'#b0a0d0',ai:'#5da5da',outlook:w.scenarioCss};
  const anyOvr=Object.values(overrides).some(v=>v!==null);
  let h='';
  h+='<div class="ws-hero"><span class="ws-score" style="color:'+w.scenarioCss+'">'+w.score+'</span><div><span class="ws-grade" style="color:'+w.scenarioCss+';border-color:'+w.scenarioCss+'">'+w.grade+'</span><span class="ws-era">'+w.era+' Era</span></div></div>';
  if(anyOvr)h+='<div style="font-size:9px;color:rgba(255,255,255,0.25);margin-bottom:6px;letter-spacing:0.05em">Based on global <span style="color:'+w.scenarioCss+'">'+w.scenarioName+'</span>. System overrides apply to the network above.</div>';
  h+='<div class="ws-feel">'+w.eraFeel+'</div>';

  const sections=[
    {label:'People & Livelihoods',text:w.livelihoods,color:sColors.livelihoods},
    {label:'Climate & Energy',text:w.climate,color:sColors.climate},
    {label:'Trust & Governance',text:w.governance,color:sColors.governance},
    {label:'AI & the Future',text:w.aiText,color:sColors.ai},
    {label:'The Road Ahead',text:w.outlook,color:sColors.outlook}
  ];
  sections.forEach(s=>{
    h+='<div class="ws-section"><div class="ws-section-label" style="color:'+s.color+'">'+s.label+'</div><p>'+s.text+'</p></div>';
  });

  h+='<div class="ws-nums">';
  const simE=window.SIM_ENGINE;
  const nums=[
    {lbl:'GINI',val:w.gini.toFixed(3),base:'0.385',clr:w.gini<=.385?'#4ecdc4':'#d4622a'},
    {lbl:'Trust',val:w.trust.toFixed(3),base:'0.432',clr:w.trust>=.432?'#4ecdc4':'#d4622a'},
    {lbl:'Emis',val:w.emis.toFixed(1)+'Gt',base:'36.3Gt',clr:w.emis<=36.3?'#4ecdc4':'#d4622a'},
    {lbl:'Resil',val:w.resil.toFixed(3),base:'0.355',clr:w.resil>=.355?'#4ecdc4':'#d4622a'},
    {lbl:'AI',val:w.ai.toFixed(3),base:'0.121',clr:w.scenarioCss}
  ];
  nums.forEach(n=>{
    h+='<div class="ws-num"><div class="lbl">'+n.lbl+'</div><div class="val" style="color:'+n.clr+'">'+n.val+'</div><div class="base">from '+n.base+'</div></div>';
  });
  h+='</div>';

  worldBody.innerHTML=h;
}

/* Auto-init audio on first user gesture (browser policy) */
function autoInitAudio(){
  if(audioInited)return;
  initAudio();
  if(!audioMuted&&masterGain)masterGain.gain.setTargetAtTime(0.3,audioCtx.currentTime,0.4);
  updateAudio();
  document.removeEventListener('click',autoInitAudio);
  document.removeEventListener('touchstart',autoInitAudio);
  document.removeEventListener('keydown',autoInitAudio);
}
document.addEventListener('click',autoInitAudio);
document.addEventListener('touchstart',autoInitAudio,{passive:true});
document.addEventListener('keydown',autoInitAudio);

/* Mute */
const muteBtn=document.getElementById('mute-btn');
muteBtn.addEventListener('click',()=>{
  if(!audioInited)initAudio();
  audioMuted=!audioMuted;
  muteBtn.textContent=audioMuted?'Sound Off':'Sound On';
  muteBtn.classList.toggle('on',!audioMuted);
  if(masterGain)masterGain.gain.setTargetAtTime(audioMuted?0:0.3,audioCtx.currentTime,0.2);
  if(!audioMuted)updateAudio();
});

/* ================================================================
   UPDATE FUNCTIONS
   ================================================================ */
function updateInfo(){
  const p=document.getElementById('info');
  if(!selNode){p.classList.add('hidden');return}
  p.classList.remove('hidden');
  let name,sc,g,c,proj2050,projG,whenTxt,desc,navTxt,nodeSc;
  if(selNode.isCenter){
    name='Civilization';sc=mixedAgg();g=grade(sc);
    const anyOvr=Object.values(overrides).some(v=>v!==null);
    nodeSc=anyOvr?'mixed':active;
    const scMeta=SC_META[active];
    proj2050=mixedAgg(2050);projG=grade(proj2050);
    c=anyOvr?'#fff':scMeta.css;
    desc='Weighted aggregate across all six operating systems. '+(anyOvr?'Mixed scenario state \u2014 systems running independent scenarios.':'All systems under '+scMeta.name+'.');
    navTxt='Click a surrounding node to explore a system';
  }else{
    const d=selNode.data;nodeSc=eff(d.id);
    const scMeta=SC_META[nodeSc];
    sc=scAt(d.today,d.proj[nodeSc],year);g=grade(sc);
    proj2050=d.proj[nodeSc];projG=grade(proj2050);
    c='#'+selNode.color.getHexString();desc=d.desc;navTxt='Double-click to open '+d.label;
  }
  const effMeta=SC_META[typeof nodeSc==='string'&&SC_META[nodeSc]?nodeSc:active];
  whenTxt=year===2026?"Today\u2019s baseline":'Projected '+year+' ('+effMeta.name+')';
  document.getElementById('info-name').textContent=name;
  document.getElementById('info-name').style.color=c;
  document.getElementById('info-sc').textContent=sc;
  document.getElementById('info-sc').style.color=c;
  document.getElementById('info-gr').textContent=g;
  document.getElementById('info-gr').style.color=c;
  document.getElementById('info-gr').style.borderColor=c;
  document.getElementById('info-when').textContent=whenTxt;
  document.getElementById('info-fill').style.width=sc+'%';
  document.getElementById('info-fill').style.background=c;
  document.getElementById('info-desc').textContent=desc;
  document.getElementById('info-nav').textContent=navTxt;
  const projEl=document.getElementById('info-proj');
  if(projEl){
    projEl.innerHTML='<span style="color:rgba(255,255,255,0.35)">2050 ('+effMeta.name+'):</span> <span style="color:'+effMeta.css+';font-weight:600">'+proj2050+'</span> <span style="color:rgba(255,255,255,0.25)">/100</span> <span style="border:1px solid '+effMeta.css+';color:'+effMeta.css+';padding:1px 5px;border-radius:2px;font-size:10px">'+projG+'</span>';
  }
  /* Sparkline charts */
  const chartsEl=document.getElementById('info-charts');
  if(chartsEl){
    const VM=window.VIZ_METRICS;
    if(selNode&&!selNode.isCenter&&VM&&VM[selNode.data.id]){
      const metrics=VM[selNode.data.id];
      const nSc=eff(selNode.data.id);
      const scClr=SC_META[nSc].css;
      const yi=Math.min(24,Math.max(0,year-2026));
      let ch='';
      metrics.forEach(m=>{
        const d=m.data[nSc];
        const curVal=d[yi];
        const endVal=d[24];
        const arrow=m.dir==='higher'?(endVal>d[0]?'\u2197':'\u2198'):(endVal<d[0]?'\u2197':'\u2198');
        const arClr=m.dir==='higher'?(endVal>=d[0]?'#4ecdc4':'#d4622a'):(endVal<=d[0]?'#4ecdc4':'#d4622a');
        ch+='<div class="info-chart-row">';
        ch+='<div class="info-chart-label"><span>'+m.label+'</span><span class="info-chart-val" style="color:'+scClr+'">'+curVal.toFixed(m.unit==='%'||m.unit==='/100'?0:1)+m.unit+' <span style="color:'+arClr+'">'+arrow+'</span></span></div>';
        ch+=timelineSVG(m.data,{aggressive:'#4ecdc4',moderate:'#5da5da',bau:'#e8a838',worst:'#d4622a'},nSc,220,28,['2026','2050'],yi);
        ch+='</div>';
      });
      chartsEl.innerHTML=ch;
    }else if(selNode&&selNode.isCenter&&VM){
      let ch='';
      SYS.forEach(s=>{
        const metrics=VM[s.id];if(!metrics||!metrics.length)return;
        const m=metrics[0];
        const nSc=eff(s.id);
        const sysClr='#'+new THREE.Color(s.color).getHexString();
        const yi=Math.min(24,Math.max(0,year-2026));
        const curVal=m.data[nSc][yi];
        const scClr=SC_META[nSc].css;
        ch+='<div class="info-chart-row">';
        ch+='<div class="info-chart-label"><span style="color:'+sysClr+'">'+s.label+'</span><span class="info-chart-val" style="color:'+scClr+'">'+curVal.toFixed(m.unit==='%'||m.unit==='/100'?0:1)+m.unit+'</span></div>';
        const singleDs={};singleDs[nSc]=m.data[nSc];
        ch+=timelineSVG(singleDs,{aggressive:'#4ecdc4',moderate:'#5da5da',bau:'#e8a838',worst:'#d4622a'},nSc,220,22,null,yi);
        ch+='</div>';
      });
      chartsEl.innerHTML=ch;
    }else{chartsEl.innerHTML=''}
  }
  /* Override scenario picker */
  const ovrEl=document.getElementById('info-override');
  if(ovrEl&&selNode&&!selNode.isCenter){
    const sid=selNode.data.id;
    const cur=overrides[sid];
    let oh='<div class="info-override-label">Scenario Override</div><div class="info-override-btns">';
    oh+='<button class="ovr-btn ovr-global'+(cur===null?' ovr-active':'')+'" data-ovr="__global" style="'+(cur===null?'color:rgba(255,255,255,0.7);border-color:rgba(255,255,255,0.3)':'')+'">Global ('+SC_META[active].name.split(' ')[0]+')</button>';
    ['aggressive','moderate','bau','worst'].forEach(k=>{
      const m=SC_META[k];
      const isA=cur===k;
      oh+='<button class="ovr-btn'+(isA?' ovr-active':'')+'" data-ovr="'+k+'" style="'+(isA?'color:'+m.css+';border-color:'+m.css:'')+'">'+m.name.split(' ')[0]+'</button>';
    });
    oh+='</div>';
    ovrEl.innerHTML=oh;
    ovrEl.querySelectorAll('.ovr-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const v=btn.dataset.ovr;
        overrides[sid]=v==='__global'?null:v;
        sfx('override');updateVis();updateInfo();renderOverrideBar();
      });
    });
  }else if(ovrEl&&selNode&&selNode.isCenter){
    const anyOvr=Object.values(overrides).some(v=>v!==null);
    ovrEl.innerHTML=anyOvr?'<button class="ovr-btn" id="reset-all-ovr" style="margin-top:8px;color:#d4622a;border-color:#d4622a">Reset All to Global</button>':'';
    const rb=document.getElementById('reset-all-ovr');
    if(rb)rb.addEventListener('click',()=>{Object.keys(overrides).forEach(k=>{overrides[k]=null});sfx('override');updateVis();updateInfo();renderOverrideBar()});
  }else if(ovrEl){ovrEl.innerHTML=''}
}
function updateAgg(){
  const anyOvr=Object.values(overrides).some(v=>v!==null);
  const sc=anyOvr?mixedAgg():scAt(AGG.today,AGG.proj[active],year);
  const c=anyOvr?'#fff':SC_META[active].css;
  document.getElementById('agg-score').textContent=sc;
  document.getElementById('agg-score').style.color=c;
  document.getElementById('agg-grade').textContent=grade(sc);
  document.getElementById('agg-grade').style.color=c;
  document.getElementById('agg-status').textContent=anyOvr?'Mixed scenario — systems running independently':SC_META[active].outcome;
}
function renderOverrideBar(){
  const bar=document.getElementById('override-bar');if(!bar)return;
  const active_ovrs=Object.entries(overrides).filter(([k,v])=>v!==null);
  if(!active_ovrs.length){bar.innerHTML='';return}
  let h='';
  active_ovrs.forEach(([sid,sc])=>{
    const sys=SYS.find(s=>s.id===sid);if(!sys)return;
    const m=SC_META[sc];
    h+='<div class="override-chip" data-sid="'+sid+'">';
    h+='<span class="chip-dot" style="background:#'+new THREE.Color(sys.color).getHexString()+'"></span>';
    h+='<span class="chip-name">'+sys.label.replace('OS','')+'</span>';
    h+='<span class="chip-sc" style="color:'+m.css+'">'+m.name.split(' ')[0]+'</span>';
    h+='<span class="chip-reset" title="Reset to global">&times;</span>';
    h+='</div>';
  });
  bar.innerHTML=h;
  bar.querySelectorAll('.chip-reset').forEach(el=>{
    el.addEventListener('click',e=>{
      e.stopPropagation();
      const sid=el.closest('.override-chip').dataset.sid;
      overrides[sid]=null;sfx('override');updateVis();updateInfo();renderOverrideBar();
    });
  });
}

const sickColor=new THREE.Color(0x444455);
const alarmColor=new THREE.Color(0xd4622a);
let aggHealth=0.44;

/* ================================================================
   TRANSITION SYSTEM — smooth lerp between scenario states
   applyScenario sets TARGETS; tick() lerps current values toward them.
   ================================================================ */
const LERP_SPEED=4.5;
const tgt={
  aggHealth:0.44,
  centerColor:new THREE.Color(0x4ecdc4),
  cScale:1,cEmissive:new THREE.Color(),cOpacity:0.8,
  bloomStr:1,fogDen:0.035,autoSpd:0.5,gridColor:new THREE.Color(0x111122),
  pulseColor:new THREE.Color(),ringColor:new THREE.Color(),
  nodes:[],conns:[]
};
nodes.forEach(n=>tgt.nodes.push({
  health:n.today/100||0.5,scale:1,emissiveI:0.3,opacity:0.8,
  emissive:new THREE.Color().copy(n.baseColor),spriteColor:new THREE.Color().copy(n.baseColor),
  spriteOp:0.1,glowScale:3,connOp:0,connColor:new THREE.Color()
}));
conns.forEach(()=>tgt.conns.push({opacity:0.05,color:new THREE.Color(0x444466)}));

function applyScenario(sc){
  const scC=new THREE.Color(SC_META[sc].color);
  const anyOvr=Object.values(overrides).some(v=>v!==null);
  const aggSc=anyOvr?mixedAgg():scAt(AGG.today,AGG.proj[sc],year);
  tgt.aggHealth=aggSc/100;
  /* Center node targets */
  const centerC=anyOvr?new THREE.Color(0xaaaacc):scC;
  tgt.ringColor.copy(centerC);
  tgt.pulseColor.lerpColors(alarmColor,centerC,tgt.aggHealth);
  tgt.cScale=0.3+tgt.aggHealth*0.9;
  tgt.cEmissive.copy(centerC).multiplyScalar(0.15+tgt.aggHealth*0.2);
  tgt.cOpacity=0.25+tgt.aggHealth*0.6;
  tgt.centerColor.copy(centerC);
  /* Per-node targets */
  nodes.forEach((n,i)=>{
    const nSc=eff(n.data.id);
    const s=scAt(n.data.today,n.data.proj[nSc],year)/100;
    n.effSc=nSc;
    const nt=tgt.nodes[i];
    nt.health=s;
    nt.scale=0.3+s*1.0;
    nt.emissiveI=0.05+s*0.6;
    nt.opacity=0.5+s*0.5;
    const desat=new THREE.Color().lerpColors(sickColor,n.baseColor,Math.pow(s,0.6));
    nt.emissive.copy(desat);
    nt.spriteColor.copy(desat);
    nt.spriteOp=0.02+s*0.2;
    nt.glowScale=1.5+s*2.5;
  });
  /* Connection targets */
  conns.forEach((c,i)=>{
    const ct=tgt.conns[i];
    if(c.toC){
      const nSc=eff(c.a.data.id);
      const sA=scAt(c.a.data.today,c.a.data.proj[nSc],year);
      const h=sA/100;
      ct.opacity=0.06+h*0.3;ct.color.set(SC_META[nSc].color);
    }else{
      const idA=c.a.data.id,idB=c.b.data.id;
      const scA=eff(idA),scB=eff(idB);
      const wAB=xw(idA,idB,scA).w,wBA=xw(idB,idA,scB).w;
      const net=wAB+wBA;const mag=Math.max(Math.abs(wAB),Math.abs(wBA));
      ct.color.set(net>0.01?0x4ecdc4:net<-0.01?0xd4622a:0x444466);
      ct.opacity=0.02+mag*0.6;
    }
  });
  /* Global atmosphere targets */
  tgt.bloomStr=0.25+tgt.aggHealth*1.0;
  tgt.fogDen=0.055-tgt.aggHealth*0.035;
  tgt.autoSpd=0.1+tgt.aggHealth*0.5;
  tgt.gridColor.lerpColors(new THREE.Color(0x331111),new THREE.Color(0x111122),tgt.aggHealth);
}

function lerpScenario(dt){
  const a=1-Math.exp(-LERP_SPEED*dt);
  aggHealth=lerp(aggHealth,tgt.aggHealth,a);
  /* Center node */
  ringM.color.lerp(tgt.ringColor,a);
  pulseM.color.lerp(tgt.pulseColor,a);
  const cs=lerp(cMesh.scale.x,tgt.cScale,a);cMesh.scale.setScalar(cs);
  cMat.emissive.lerp(tgt.cEmissive,a);
  cMat.opacity=lerp(cMat.opacity,tgt.cOpacity,a);
  /* Per-node */
  nodes.forEach((n,i)=>{
    const nt=tgt.nodes[i];
    n.health=lerp(n.health,nt.health,a);
    const ns=lerp(n.mesh.scale.x,nt.scale,a);n.mesh.scale.setScalar(ns);
    n.mesh.material.emissiveIntensity=lerp(n.mesh.material.emissiveIntensity,nt.emissiveI,a);
    n.mesh.material.opacity=lerp(n.mesh.material.opacity,nt.opacity,a);
    n.mesh.material.emissive.lerp(nt.emissive,a);
    n.spriteMat.color.lerp(nt.spriteColor,a);
    n.spriteMat.opacity=lerp(n.spriteMat.opacity,nt.spriteOp,a);
    const gCur=n.mesh.children[0]&&n.mesh.children[0].isSprite?n.mesh.children[0].scale.x:nt.glowScale;
    const g=lerp(gCur,nt.glowScale,a);
    n.mesh.children.forEach(ch=>{if(ch.isSprite)ch.scale.set(g,g,1)});
  });
  /* Connections */
  conns.forEach((c,i)=>{
    const ct=tgt.conns[i];
    c.mat.opacity=lerp(c.mat.opacity,ct.opacity,a);
    c.mat.color.lerp(ct.color,a);
  });
  /* Atmosphere */
  bloom.strength=lerp(bloom.strength,tgt.bloomStr,a);
  scene.fog.density=lerp(scene.fog.density,tgt.fogDen,a);
  ctrl.autoRotateSpeed=lerp(ctrl.autoRotateSpeed,tgt.autoSpd,a);
  gridM.color.lerp(tgt.gridColor,a);
}

function updateVis(){
  applyScenario(active);
  updateAgg();updateInfo();updateAudio();
  if(chartsActive)renderNodeCharts();
  updateWorldPanel();
}
updateVis();

/* ================================================================
   CONNECTION TOOLTIP
   ================================================================ */
const connTip=document.getElementById('conn-tip');
function updateConnTooltip(){
  if(!selNode||comparing){connTip.classList.add('hidden');return}
  if(selNode.isCenter){connTip.classList.add('hidden');return}
  const sId=selNode.data.id;
  let bestConn=null,bestDist=Infinity;
  conns.forEach(c=>{
    const linked=(c.a===selNode||c.b===selNode);if(!linked)return;
    const mid3=c.curve.getPoint(0.5).clone().project(camera);
    const mx=(mid3.x*0.5+0.5)*W(),my=(-mid3.y*0.5+0.5)*H();
    const d=Math.hypot(mx-mouseScreen.x,my-mouseScreen.y);
    if(d<bestDist){bestDist=d;bestConn=c}
  });
  if(!bestConn||bestDist>80){connTip.classList.add('hidden');return}
  const other=bestConn.a===selNode?bestConn.b:bestConn.a;
  if(other.isCenter){
    const nSc=eff(sId);
    const sNow=scAt(selNode.data.today,selNode.data.proj[nSc],year);
    const contrib=Math.round(sNow/SYS.length);
    const clrC=sNow>=50?'#4ecdc4':'#d4622a';
    connTip.innerHTML='<div class="conn-tip-head">'+selNode.data.label+' \u2194 Civilization</div>'
      +'<div style="margin:6px 0"><span class="conn-tip-pct" style="color:'+clrC+'">'+sNow+'</span> system health ('+grade(sNow)+')</div>'
      +'<div style="color:rgba(255,255,255,0.45)">Contributes ~'+contrib+' pts to aggregate score. '+(sNow>=70?'Strong positive contributor.':sNow>=50?'Moderate contributor.':sNow>=30?'Underperforming \u2014 dragging aggregate down.':'Critical weakness \u2014 major drag on civilization index.')+'</div>';
  }else{
    const oId=other.data.id;
    const ab=xw(sId,oId,eff(sId)),ba=xw(oId,sId,eff(oId));
    const pctAB=(ab.w*100).toFixed(0),pctBA=(ba.w*100).toFixed(0);
    const clrAB=ab.w>=0?'#4ecdc4':'#d4622a',clrBA=ba.w>=0?'#4ecdc4':'#d4622a';
    connTip.innerHTML='<div class="conn-tip-head">'+selNode.data.label+' \u2194 '+other.data.label+'</div>'
      +'<div style="margin:6px 0"><span class="conn-tip-pct" style="color:'+clrAB+'">'+(ab.w>0?'+':'')+pctAB+'%</span> '+selNode.data.label+' \u2192 '+other.data.label+'</div>'
      +'<div style="color:rgba(255,255,255,0.45);margin-bottom:6px">'+ab.e+'</div>'
      +'<div><span class="conn-tip-pct" style="color:'+clrBA+'">'+(ba.w>0?'+':'')+pctBA+'%</span> '+other.data.label+' \u2192 '+selNode.data.label+'</div>'
      +'<div style="color:rgba(255,255,255,0.45)">'+ba.e+'</div>';
  }
  connTip.classList.remove('hidden');
  connTip.style.left=Math.min(mouseScreen.x+16,W()-300)+'px';
  connTip.style.top=Math.min(mouseScreen.y-10,H()-200)+'px';
}

/* ================================================================
   TIPPING POINTS
   ================================================================ */
const tipEl=document.getElementById('tip-event');
let tipTimer=0;
function checkTipping(){
  TIPPING.forEach(tp=>{
    const thr=tp.thresholds[active];if(!thr)return;
    const key=tp.label+'_'+active;
    if(tipFired[key])return;
    if(year>=thr){
      tipFired[key]=true;
      const nd=nodes.find(n=>n.data.id===tp.node);
      if(nd)spawnShock(nd.mesh.position);
      tipEl.innerHTML='<div class="tip-event-title">\u26a0 '+tp.label+'</div><div class="tip-event-sub">Threshold breached in '+thr+' under '+SC_META[active].name+'</div>';
      tipEl.classList.remove('hidden');tipTimer=3;
    }
  });
}

/* ================================================================
   ANIMATION LOOP
   ================================================================ */
const clock=new THREE.Clock();
let playAcc=0,pulseT=0;

function tick(){
  requestAnimationFrame(tick);
  const dt=clock.getDelta(),t=clock.getElapsedTime();
  ctrl.update();

  /* Smooth transition between scenario states */
  lerpScenario(dt);

  /* Camera fly-to */
  if(flyProgress<1){
    flyProgress=Math.min(1,flyProgress+dt*2.2);
    const e=flyProgress<0.5?2*flyProgress*flyProgress:1-Math.pow(-2*flyProgress+2,2)/2;
    camera.position.lerpVectors(camera.position,flyPos,e*0.12);
    ctrl.target.lerp(flyTarget,e*0.12);
  }

  /* Play timeline */
  if(playing){
    playAcc+=dt;
    if(playAcc>0.15){
      playAcc=0;
      const prevYear=year;
      year=year>=2050?2026:year+1;
      if(year===2026){clearTrail();tipFired={}}
      yrSlider.value=year;yrVal.textContent=year;
      updateVis();checkTipping();
      /* Timeline trail */
      const aggSc=scAt(AGG.today,AGG.proj[active],year);
      const m=new THREE.Mesh(trailGeo.clone(),trailMat.clone());
      m.material.color=new THREE.Color(SC_META[active].color);
      m.material.opacity=0.6;
      m.position.copy(cMesh.position);
      const s=0.3+aggSc/100*0.7;m.scale.setScalar(s);
      scene.add(m);trailSpheres.push({mesh:m,birth:t});
      if(trailSpheres.length>25){const old=trailSpheres.shift();scene.remove(old.mesh);old.mesh.geometry.dispose()}
    }
  }

  /* Trail fade */
  trailSpheres.forEach((ts,i)=>{ts.mesh.material.opacity=0.15+0.45*(i/trailSpheres.length)});

  /* Node animation — per-node health-driven */
  nodes.forEach((n,i)=>{
    const h=n.health;
    const spinSpd=0.02+h*0.2;
    n.wire.rotation.y+=spinSpd*dt*6+i*0.001;
    n.wire.rotation.x+=spinSpd*dt*4;
    const bobAmp=h>0.5?0.15:0.15+((0.5-h)*0.6);
    const bobFreq=h>0.5?0.7:0.7+((0.5-h)*3.0);
    const jitter=h<0.35?(0.35-h)*0.12*Math.sin(t*17+i*7):0;
    n.mesh.position.y=n.bp.y+Math.sin(t*bobFreq+i*1.1)*bobAmp+jitter;
    n.alarmPhase+=dt*(1.5+(1-h)*6);
    const alarmIntensity=Math.max(0,(0.55-h)/0.55);
    const alarmPulse=Math.abs(Math.sin(n.alarmPhase));
    n.alarmMat.opacity=alarmIntensity*alarmPulse*0.35;
    const aScale=1+alarmPulse*alarmIntensity*1.8;
    n.alarmRing.scale.set(aScale,aScale,aScale);
    n.alarmMat.color.lerpColors(n.baseColor,alarmColor,alarmIntensity);
    n.wire.material.opacity=(n===hovNode||n===selNode)?0.45:0.08+h*0.16;
    /* Override indicator — colored wireframe tint */
    if(overrides[n.data.id]){
      const ovrC=new THREE.Color(SC_META[overrides[n.data.id]].color);
      n.wire.material.color.lerp(ovrC,0.5+Math.sin(t*3+n.idx)*0.2);
      n.wire.material.opacity=Math.max(n.wire.material.opacity,0.25+Math.sin(t*2+n.idx)*0.08);
    }else{
      n.wire.material.color.copy(n.baseColor);
    }
  });
  const cH=aggHealth;
  const cSpinSpd=0.04+cH*0.22;
  cWire.rotation.y+=cSpinSpd*dt*5;cWire.rotation.z+=cSpinSpd*dt*3;
  const cBobAmp=cH>0.5?0.10:0.10+((0.5-cH)*0.4);
  const cBobFreq=cH>0.5?0.45:0.45+((0.5-cH)*2.5);
  cMesh.position.y=centerNode.bp.y+Math.sin(t*cBobFreq)*cBobAmp;

  /* Pulse ring — faster alarm when health is low */
  if(!globeActive){
    const pulseSpd=0.4+((1-aggHealth)*1.2);
    pulseT+=dt*pulseSpd;if(pulseT>1)pulseT-=1;
    pulseMesh.scale.setScalar(0.3+pulseT*(R+1));
    const pulseBase=aggHealth>0.5?0.08:0.08+(0.5-aggHealth)*0.25;
    pulseM.opacity=pulseBase*(1-pulseT);
    const ringPulse=aggHealth>0.5?0.012:0.012+(0.5-aggHealth)*0.04;
    ringM.opacity=0.02+Math.sin(t*(1.5+(1-aggHealth)*3))*ringPulse;
  }

  /* Shockwaves */
  shockPool.forEach(s=>{
    if(!s.active)return;
    s.t+=dt*1.5;const sc=1+s.t*6;
    s.mesh.scale.set(sc,sc,sc);s.mat.opacity=Math.max(0,0.5-s.t*0.5);
    if(s.t>1){s.active=false;s.mesh.visible=false}
  });

  /* Tipping point text fade */
  if(tipTimer>0){tipTimer-=dt;if(tipTimer<=0)tipEl.classList.add('hidden')}

  /* Particles */
  const aggSc=scAt(AGG.today,AGG.proj[active],year);
  const spdMul=0.25+aggSc/100*1.6;
  const health=aggSc/100;
  for(let i=0;i<pData.length;i++){
    const d=pData[i];
    const conn=conns[d.ci];
    let dir=1;
    if(!conn.toC&&conn.a.data&&conn.b.data){
      const w=xw(conn.a.data.id,conn.b.data.id,eff(conn.a.data.id)).w;
      dir=w>=0?1:-1;
    }
    d.t+=d.spd*spdMul*dir;
    if(d.t>1)d.t-=1;if(d.t<0)d.t+=1;
    const pt=conn.curve.getPoint(d.t);
    if(health<0.4){
      const scatter=(0.4-health)*0.5;
      pt.x+=Math.sin(t*3+i)*scatter;pt.y+=Math.cos(t*2.5+i*0.7)*scatter*0.5;pt.z+=Math.sin(t*2+i*1.3)*scatter;
    }
    pPos[i*3]=pt.x;pPos[i*3+1]=pt.y;pPos[i*3+2]=pt.z;
  }
  pGeo.attributes.position.needsUpdate=true;
  pMat.opacity=0.15+health*0.55;

  /* Raycaster */
  ray.setFromCamera(mouse,camera);
  const hits=ray.intersectObjects(allHitMeshes);
  const prevHov=hovNode;
  hovNode=null;
  if(hits.length){const ht=hitTargets.find(h=>h.mesh===hits[0].object);if(ht)hovNode=ht.node;renderer.domElement.style.cursor='pointer'}
  else{renderer.domElement.style.cursor='default'}
  if(hovNode!==prevHov){if(hovNode)sfx('hover');else if(prevHov)sfx('unhover')}

  /* Connection highlights */
  conns.forEach(c=>{
    if(selNode){
      const linked=c.a===selNode||c.b===selNode;
      if(linked)c.mat.opacity=Math.max(c.mat.opacity,0.3);
    }
  });

  /* Center wireframe highlight */
  cWM.opacity=(hovNode===centerNode||selNode===centerNode)?0.3:0.06+aggHealth*0.1;

  /* Connection tooltip */
  updateConnTooltip();

  /* Hover tooltip */
  const hTip=document.getElementById('hover-tip');
  if(hovNode&&hovNode!==selNode){
    let tipName,tipScore,tipGrade,tipColor,tipSub,ovrTag='';
    if(hovNode.isCenter){
      tipName='Civilization';tipScore=mixedAgg();tipGrade=grade(tipScore);
      tipColor=Object.values(overrides).some(v=>v!==null)?'#fff':SC_META[active].css;
      tipSub='Aggregate of all 6 systems &middot; Click to inspect';
    }else{
      const d=hovNode.data;const nSc=eff(d.id);
      tipScore=scAt(d.today,d.proj[nSc],year);tipGrade=grade(tipScore);
      tipColor='#'+hovNode.color.getHexString();tipName=d.label;
      tipSub='Click to inspect &middot; Double-click to open';
      if(overrides[d.id])ovrTag=' <span style="font-size:8px;color:'+SC_META[nSc].css+';border:1px solid '+SC_META[nSc].css+';padding:1px 4px;border-radius:2px">'+SC_META[nSc].name.split(' ')[0]+'</span>';
    }
    hTip.innerHTML='<div class="hover-tip-name" style="color:'+tipColor+'">'+tipName+ovrTag+'</div><div class="hover-tip-score" style="color:'+tipColor+'">'+tipScore+' <span style="font-size:10px;color:rgba(255,255,255,0.3)">/100</span> '+tipGrade+'</div><div class="hover-tip-sub">'+tipSub+'</div>';
    hTip.style.left=(mouseScreen.x+16)+'px';hTip.style.top=(mouseScreen.y-10)+'px';
    hTip.classList.remove('hidden');
  }else{hTip.classList.add('hidden')}

  /* Labels */
  const hw=W()/2,hh=H()/2;
  labels.forEach(lb=>{
    const v=new THREE.Vector3().copy(lb.mesh.position);v.y+=lb.isCenter?1.0:0.85;
    v.project(camera);
    if(v.z>1){lb.el.style.display='none';return}
    lb.el.style.display='';
    lb.el.style.left=(v.x*hw+hw)+'px';
    lb.el.style.top=(-v.y*hh+hh)+'px';
    lb.el.style.transform='translate(-50%,-100%)';
    if(lb.isCenter){const s=mixedAgg();lb.scoreEl.textContent=s;const anyO=Object.values(overrides).some(v=>v!==null);lb.scoreEl.style.color=anyO?'#fff':SC_META[active].css}
    else{const nSc=eff(lb.node.data.id);const s=scAt(lb.node.data.today,lb.node.data.proj[nSc],year);lb.scoreEl.textContent=s;if(overrides[lb.node.data.id])lb.scoreEl.style.color=SC_META[nSc].css}
  });

  /* Update compare panel if open */
  if(comparing) updateComparePanel();

  /* Keep audio in sync with lerping health values */
  updateAudio();

  /* Position floating charts in screen space */
  positionNodeCharts();

  /* RENDER */
  composer.render();
}
tick();

window.addEventListener('resize',()=>{
  camera.aspect=W()/H();camera.updateProjectionMatrix();
  renderer.setSize(W(),H());composer.setSize(W(),H());
});
</script>
</body>
</html>
